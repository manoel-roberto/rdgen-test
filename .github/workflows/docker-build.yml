# Workflow para atualização automática de imagem Docker
# Constrói e publica imagem Docker quando há mudanças nas branches principais

name: update docker image

# Gatilhos: push nas branches dev/master ou criação de tags versionadas
on:
  push:
    branches:
      - dev      # Branch de desenvolvimento
      - master   # Branch principal
    tags:
      - 'v*.*.*' # Tags de versão (ex: v1.0.0)

# Definição dos jobs
jobs:
  # Job principal: construir e publicar imagem Docker
  build:
    runs-on: ubuntu-latest  # Ubuntu mais recente
    steps:
      # Step 1: Definir tag da imagem Docker baseada na branch/tag
      - name: set docker image tag
        run: |
          # Lógica condicional para definir tag da imagem
          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "IMAGE_TAG=dev" >> "$GITHUB_ENV"        # Branch dev → tag "dev"
            echo "CREATE_IMAGE=true" >> "$GITHUB_ENV"    # Criar imagem
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "IMAGE_TAG=${{ github.ref_name }}" >> "$GITHUB_ENV"  # Tag → usar nome da tag
            echo "CREATE_IMAGE=true" >> "$GITHUB_ENV"    # Criar imagem
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "IMAGE_TAG=latest" >> "$GITHUB_ENV"     # Branch master → tag "latest"
            echo "CREATE_IMAGE=true" >> "$GITHUB_ENV"    # Criar imagem
          else
            echo "CREATE_IMAGE=false" >> "$GITHUB_ENV"   # Outros casos → não criar
          fi

      # Step 2: Login no Docker Hub
      # Autenticação necessária para publicar imagens
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: env.CREATE_IMAGE == 'true'  # Só executa se deve criar imagem
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}  # Usuário do Docker Hub
          password: ${{ secrets.DOCKERHUB_TOKEN }}  # Token de acesso

      # Step 3: Configurar Docker Buildx
      # Buildx permite builds multi-plataforma e recursos avançados
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        if: env.CREATE_IMAGE == 'true'  # Só executa se deve criar imagem

      # Step 4: Construir e publicar imagem
      # Build da imagem e push para Docker Hub
      - name: Build and push
        uses: docker/build-push-action@v6
        if: env.CREATE_IMAGE == 'true'  # Só executa se deve criar imagem
        with:
          push: true  # Fazer push da imagem após build
          tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ env.IMAGE_TAG }}  # Tag completa da imagem
